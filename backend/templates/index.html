<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"/>
<title>La B√∫squeda Navide√±a ‚Äî Pixel Adventure</title>
<style>
  :root{
    --bg:#0b1a1a;
    --panel:#071014;
    --accent:#ffd86b;
    --text:#f6f7f9;
  }
  html,body { height:100%; margin:0; background: linear-gradient(180deg,#08202a,#03111b); font-family: Inter, system-ui, sans-serif; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; touch-action: none; }
  #gameWrap { width:100%; height:100vh; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:8px; box-sizing:border-box; padding:12px; }
  canvas { image-rendering: pixelated; background: linear-gradient(180deg,#072033,#022026); border-radius:8px; box-shadow: 0 10px 30px rgba(0,0,0,0.6); }
  .hud { width:100%; max-width:900px; display:flex; justify-content:space-between; align-items:center; color:var(--text); gap:10px; }
  .panel { background:rgba(0,0,0,0.2); padding:8px 12px; border-radius:8px; display:flex; gap:12px; align-items:center; }
  .button { background:var(--accent); color:#000; padding:6px 10px; border-radius:6px; cursor:pointer; font-weight:700; border:none; }
  #inventory { display:flex; gap:8px; align-items:center; }
  .item { display:flex; gap:6px; align-items:center; padding:6px 8px; background:rgba(255,255,255,0.04); border-radius:6px; }
  #mobileControls { position: absolute; bottom:18px; left:18px; display:none; gap:8px; }
  .dpad { width:140px; height:140px; background: rgba(0,0,0,0.25); border-radius:12px; display:grid; grid-template-columns:repeat(3,1fr); grid-template-rows:repeat(3,1fr); }
  .dpad button { background:transparent; border:0; color:transparent; }
  
  /* Modal styles */
  .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center; }
  .modal-content { background: var(--panel); padding: 20px; border-radius: 12px; max-width: 400px; width: 90%; text-align: center; }
  .modal input { width: 80%; padding: 10px; margin: 10px 0; border: none; border-radius: 6px; background: rgba(255,255,255,0.1); color: var(--text); }
  .modal-buttons { display: flex; gap: 10px; justify-content: center; margin-top: 15px; }
  
  /* Leaderboard styles */
  #leaderboard { margin-top: 15px; max-height: 200px; overflow-y: auto; }
  .leaderboard-item { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.1); }
  
  @media (max-width:800px){
    #mobileControls { display:block; }
    canvas { width:92vw !important; height: calc(92vw * (9/16)) !important; }
  }
  html, body, canvas { -webkit-touch-callout: none; -webkit-user-select:none; -ms-user-select:none; user-select:none; }
</style>
</head>
<body>
<div id="gameWrap">
  <div class="hud" style="max-width:900px;">
    <div class="panel">
      <div style="font-weight:800; font-size:1.05rem">La B√∫squeda Navide√±a ‚Äî Pixel Adventure</div>
      <div style="opacity:0.8; margin-left:6px">Encuentra los regalos antes de que nieve demasiado ‚õÑÔ∏è</div>
    </div>

    <div class="panel" style="justify-content:flex-end">
      <div id="status">Objetos: <span id="found">0</span>/<span id="total">0</span></div>
      <div id="inventory" style="margin-left:12px"></div>
      <button id="fullscreenBtn" class="button" style="margin-left:12px">Pantalla completa</button>
      <button id="leaderboardBtn" class="button" style="margin-left:12px">Ranking</button>
    </div>
  </div>

  <canvas id="game" width="640" height="360" style="width:960px; height:540px;"></canvas>

  <div style="max-width:900px; width:100%; display:flex; justify-content:space-between; gap:12px;">
    <div class="panel" style="flex:1">
      <div><strong>Controles:</strong> WASD / Flechas. Soporta m√∫ltiples teclas. Toca movimientos en m√≥vil con D-Pad.</div>
    </div>
    <div class="panel" style="width:300px; justify-content:space-between;">
      <div>Tiempo: <span id="timer">0</span>s</div>
      <div id="message" style="font-weight:700"></div>
    </div>
  </div>
</div>

<!-- Mobile D-Pad -->
<div id="mobileControls">
  <div class="dpad" id="dpad">
    <button data-dir="nw"></button><button data-dir="north"></button><button data-dir="ne"></button>
    <button data-dir="west"></button><button data-dir="center"></button><button data-dir="east"></button>
    <button data-dir="sw"></button><button data-dir="south"></button><button data-dir="se"></button>
  </div>
</div>

<!-- Score Submission Modal -->
<div id="scoreModal" class="modal">
  <div class="modal-content">
    <h3>¬°Felicidades! üéâ</h3>
    <p>Has encontrado todos los regalos en <span id="finalTime">0</span> segundos</p>
    <input type="text" id="discordId" placeholder="Tu ID de Discord" maxlength="50">
    <div class="modal-buttons">
      <button class="button" id="submitScore">Guardar Puntaje</button>
      <button class="button" style="background:#666" id="cancelScore">Cancelar</button>
    </div>
  </div>
</div>

<!-- Leaderboard Modal -->
<div id="leaderboardModal" class="modal">
  <div class="modal-content">
    <h3>üèÜ Mejores Puntuaciones</h3>
    <div id="leaderboard">
      <div style="text-align:center; padding:20px;">Cargando...</div>
    </div>
    <div class="modal-buttons">
      <button class="button" id="closeLeaderboard">Cerrar</button>
    </div>
  </div>
</div>

<script>
// Configuraci√≥n del backend
const API_BASE_URL = window.location.origin; // Mismo origen que la p√°gina
const SCORE_ENDPOINT = `${API_BASE_URL}/score`;
const SCORES_ENDPOINT = `${API_BASE_URL}/scores`;

const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');

// GAME CONFIG
const TILE = 32;
const MAP_W = 20, MAP_H = 11;
const VIEW_W = 20, VIEW_H = 11;
const SCALE = 2;
const PLAYER_SPEED = 2.2;
const SPRITE_SIZE = 24;
let foundCount = 0;
let gameTime = 0;
let gameTimer = null;
let gameCompleted = false;

// player state
const player = {
  x: TILE*2 + TILE/2, y: TILE*2 + TILE/2,
  vx:0, vy:0,
  dir: 'down',
  animFrame:0,
  animTick:0,
  moving:false
};

const pressedKeys = new Set();

// Game map
const map = [];
for(let y=0;y<MAP_H;y++){
  map[y] = [];
  for(let x=0;x<MAP_W;x++){
    if(y===0||y===MAP_H-1||x===0||x===MAP_W-1) map[y][x]=1;
    else map[y][x] = Math.random() < 0.05 ? 2 : (Math.random() < 0.12 ? 3 : (Math.random() < 0.02 ? 5 : 0));
  }
}

for(let i=0;i<14;i++){
  const tx = 2 + Math.floor(Math.random()*(MAP_W-4));
  const ty = 2 + Math.floor(Math.random()*(MAP_H-4));
  map[ty][tx] = 1;
}

// Hidden items
const items = [];
const ITEM_TYPES = ['regalo_rojo','regalo_verde','mu√±eco_nieve'];

for(let i=0;i<10;i++){
  let tries=0;
  while(tries<200){
    const rx = 1 + Math.floor(Math.random()*(MAP_W-2));
    const ry = 1 + Math.floor(Math.random()*(MAP_H-2));
    if((map[ry][rx]===3 || map[ry][rx]===1 || map[ry][rx]===2) && !items.find(it=>it.xTile===rx && it.yTile===ry)){
      items.push({xTile:rx,yTile:ry,type: ITEM_TYPES[Math.floor(Math.random()*ITEM_TYPES.length)],found:false});
      break;
    }
    tries++;
  }
}
document.getElementById('total').textContent = items.length;

// Camera
const camera = {x:0,y:0};

// Timer functions
function startGameTimer() {
  gameTime = 0;
  gameTimer = setInterval(() => {
    gameTime++;
    document.getElementById('timer').textContent = gameTime;
  }, 1000);
}

function stopGameTimer() {
  if (gameTimer) {
    clearInterval(gameTimer);
    gameTimer = null;
  }
}

// API Communication functions
async function submitScore(discordId, score) {
  try {
    const response = await fetch(SCORE_ENDPOINT, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        discord_id: discordId,
        score: score
      })
    });

    const result = await response.json();
    
    if (result.status === 'success') {
      showMessage('¬°Puntaje guardado exitosamente! üéâ', 'success');
      return true;
    } else {
      showMessage(result.message || 'Error al guardar puntaje', 'error');
      return false;
    }
  } catch (error) {
    console.error('Error submitting score:', error);
    showMessage('Error de conexi√≥n al servidor', 'error');
    return false;
  }
}

async function loadLeaderboard() {
  try {
    const response = await fetch(SCORES_ENDPOINT);
    const scores = await response.json();
    
    const leaderboardElement = document.getElementById('leaderboard');
    
    if (scores.length === 0) {
      leaderboardElement.innerHTML = '<div style="text-align:center; padding:20px;">No hay puntuaciones a√∫n</div>';
      return;
    }
    
    let leaderboardHTML = '';
    scores.forEach((score, index) => {
      const date = new Date(score.date).toLocaleDateString();
      leaderboardHTML += `
        <div class="leaderboard-item">
          <span>${index + 1}. ${score.discord_id}</span>
          <span>${score.score} pts</span>
          <small>${date}</small>
        </div>
      `;
    });
    
    leaderboardElement.innerHTML = leaderboardHTML;
  } catch (error) {
    console.error('Error loading leaderboard:', error);
    document.getElementById('leaderboard').innerHTML = 
      '<div style="text-align:center; padding:20px; color:#ff6b6b;">Error cargando el ranking</div>';
  }
}

// UI Helper functions
function showMessage(text, type = 'info') {
  const messageElement = document.getElementById('message');
  messageElement.textContent = text;
  messageElement.style.color = type === 'error' ? '#ff6b6b' : 
                              type === 'success' ? '#51cf66' : '#ffd86b';
  
  setTimeout(() => {
    messageElement.textContent = '';
  }, 3000);
}

function showScoreModal() {
  document.getElementById('finalTime').textContent = gameTime;
  document.getElementById('scoreModal').style.display = 'flex';
  document.getElementById('discordId').value = '';
  document.getElementById('discordId').focus();
}

function showLeaderboard() {
  loadLeaderboard();
  document.getElementById('leaderboardModal').style.display = 'flex';
}

// Event listeners for modals
document.getElementById('submitScore').addEventListener('click', async () => {
  const discordId = document.getElementById('discordId').value.trim();
  
  if (!discordId) {
    showMessage('Por favor ingresa tu ID de Discord', 'error');
    return;
  }
  
  const success = await submitScore(discordId, gameTime);
  if (success) {
    document.getElementById('scoreModal').style.display = 'none';
  }
});

document.getElementById('cancelScore').addEventListener('click', () => {
  document.getElementById('scoreModal').style.display = 'none';
});

document.getElementById('leaderboardBtn').addEventListener('click', showLeaderboard);
document.getElementById('closeLeaderboard').addEventListener('click', () => {
  document.getElementById('leaderboardModal').style.display = 'none';
});

// Close modals when clicking outside
document.querySelectorAll('.modal').forEach(modal => {
  modal.addEventListener('click', (e) => {
    if (e.target === modal) {
      modal.style.display = 'none';
    }
  });
});

// Player drawing function
function drawPlayer(ctx,px,py){
  const f = player.animFrame;
  const body = '#ffdf80';
  const hat = '#c62828';
  const muff = '#ffffff';
  
  ctx.fillStyle = body;
  ctx.fillRect(px-8, py-12, 16, 20);
  
  ctx.fillStyle = (player.moving && f%2===0) ? '#874b2f' : '#6b3b21';
  ctx.fillRect(px-6, py+6, 6, 6);
  ctx.fillRect(px+0, py+6, 6, 6);
  
  ctx.fillStyle = '#ffd8b6';
  ctx.fillRect(px-7, py-20, 14, 12);
  
  ctx.fillStyle = hat;
  ctx.fillRect(px-10, py-26, 20, 6);
  
  ctx.fillStyle = muff;
  ctx.fillRect(px+6, py-28, 4, 4);
}

// Tile drawing function
function drawTile(ctx,tx,ty,tile){
  const px = tx*TILE, py = ty*TILE;
  switch(tile){
    case 0:
      ctx.fillStyle = '#1e6b3a';
      ctx.fillRect(px,py,TILE,TILE);
      if(Math.random()<0.03){ ctx.fillStyle='#e6f7ff'; ctx.fillRect(px+4,py+4,6,6); }
      break;
    case 1:
      ctx.fillStyle = '#4b2c12';
      ctx.fillRect(px+TILE*0.45,py+TILE*0.6,TILE*0.1,TILE*0.4);
      ctx.fillStyle = '#0d5b2e';
      ctx.beginPath();
      ctx.moveTo(px+TILE*0.5, py+4);
      ctx.lineTo(px+4, py+TILE*0.65);
      ctx.lineTo(px+TILE-4, py+TILE*0.65);
      ctx.closePath();
      ctx.fill();
      ctx.fillStyle = '#ecf7ff';
      ctx.fillRect(px+6,py+6,6,2);
      break;
    case 2:
      ctx.fillStyle = '#6f6f6f';
      ctx.fillRect(px+6,py+10,TILE-12,TILE-8);
      break;
    case 3:
      ctx.fillStyle = '#0f5e2a';
      ctx.fillRect(px+4,py+8,TILE-8,TILE-6);
      ctx.fillStyle = '#ff293b';
      ctx.fillRect(px+8,py+12,2,2);
      break;
    case 4:
      ctx.fillStyle = '#dfefff';
      ctx.fillRect(px,py,TILE,TILE);
      break;
    case 5:
      ctx.fillStyle = '#073a6b';
      ctx.fillRect(px,py,TILE,TILE);
      break;
  }
}

function isPassable(tx,ty){
  if(tx<0||ty<0||tx>=MAP_W||ty>=MAP_H) return false;
  const t = map[ty][tx];
  return !(t===1 || t===2 || t===5);
}

// Input handling
window.addEventListener('keydown', (e) => {
  const k = e.key.toLowerCase();
  pressedKeys.add(k);
  if(['arrowup','arrowdown','arrowleft','arrowright',' '].includes(k)) e.preventDefault();
});

window.addEventListener('keyup', (e) => {
  pressedKeys.delete(e.key.toLowerCase());
});

// Mobile D-Pad
document.getElementById('dpad').addEventListener('touchstart', (ev)=>{
  ev.preventDefault();
  const btn = ev.target.closest('button');
  if(!btn) return;
  handleDpad(btn.dataset.dir, true);
});

document.getElementById('dpad').addEventListener('touchend', (ev)=>{
  ev.preventDefault();
  handleDpad(null, false);
});

function handleDpad(dir, down){
  pressedKeys.clear();
  if(down && dir){
    const mapDir = {
      'north': 'arrowup', 'south':'arrowdown', 'west':'arrowleft','east':'arrowright',
      'nw':'q','ne':'e','sw':'z','se':'c'
    };
    if(mapDir[dir]) pressedKeys.add(mapDir[dir]);
  }
}

// Disable double tap zoom
let lastTouch = 0;
document.addEventListener('touchend', function (e) {
  const now = Date.now();
  if (now - lastTouch <= 300) {
    e.preventDefault();
  }
  lastTouch = now;
}, { passive: false });

// Fullscreen
const fsBtn = document.getElementById('fullscreenBtn');
fsBtn.addEventListener('click', async ()=>{
  try{
    if(!document.fullscreenElement) await document.documentElement.requestFullscreen();
    else await document.exitFullscreen();
  }catch(err){}
});

// Game loop
function update(){
  if (gameCompleted) return;

  let dx=0, dy=0;
  if(pressedKeys.has('arrowup') || pressedKeys.has('w')) dy -= 1;
  if(pressedKeys.has('arrowdown') || pressedKeys.has('s')) dy += 1;
  if(pressedKeys.has('arrowleft') || pressedKeys.has('a')) dx -= 1;
  if(pressedKeys.has('arrowright') || pressedKeys.has('d')) dx += 1;
  
  if(dx!==0 && dy!==0){
    dx *= Math.SQRT1_2;
    dy *= Math.SQRT1_2;
  }
  
  player.vx = dx * PLAYER_SPEED;
  player.vy = dy * PLAYER_SPEED;
  player.moving = (dx!==0 || dy!==0);

  const nextX = player.x + player.vx;
  const nextY = player.y + player.vy;
  const nextTileX = Math.floor((nextX)/TILE);
  const nextTileY = Math.floor((nextY)/TILE);
  
  if(isPassable(Math.floor((nextX-8)/TILE), Math.floor((player.y-8)/TILE)) &&
     isPassable(Math.floor((nextX+8)/TILE), Math.floor((player.y+8)/TILE))){
    player.x = nextX;
  }
  if(isPassable(Math.floor((player.x-8)/TILE), Math.floor((nextY-8)/TILE)) &&
     isPassable(Math.floor((player.x+8)/TILE), Math.floor((nextY+8)/TILE))){
    player.y = nextY;
  }

  if(player.vx>0) player.dir='right';
  else if(player.vx<0) player.dir='left';
  else if(player.vy>0) player.dir='down';
  else if(player.vy<0) player.dir='up';

  if(player.moving){
    player.animTick++;
    if(player.animTick>6){ player.animTick=0; player.animFrame=(player.animFrame+1)%4; }
  } else {
    player.animTick++;
    if(player.animTick>12){ player.animTick=0; player.animFrame=0; }
  }

  const pTileX = Math.floor(player.x / TILE);
  const pTileY = Math.floor(player.y / TILE);
  
  items.forEach(it=>{
    if(!it.found && it.xTile===pTileX && it.yTile===pTileY){
      const centerX = it.xTile*TILE + TILE/2;
      const centerY = it.yTile*TILE + TILE/2;
      const dxC = Math.abs(centerX - player.x);
      const dyC = Math.abs(centerY - player.y);
      if(dxC < 12 && dyC < 12){
        it.found = true;
        foundCount++;
        document.getElementById('found').textContent = foundCount;
        addInventoryItem(it.type);
        
        // Check if game is completed
        if (foundCount === items.length && !gameCompleted) {
          gameCompleted = true;
          stopGameTimer();
          setTimeout(() => {
            showScoreModal();
          }, 1000);
        }
      }
    }
  });
}

function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  for(let y=0;y<MAP_H;y++){
    for(let x=0;x<MAP_W;x++){
      const t = map[y][x];
      const px = x*TILE, py = y*TILE;
      switch(t){
        case 0:
          ctx.fillStyle = '#083b1f';
          ctx.fillRect(px,py,TILE,TILE);
          break;
        case 1:
          ctx.fillStyle = '#4b2c12';
          ctx.fillRect(px+TILE*0.45,py+TILE*0.6,TILE*0.1,TILE*0.4);
          ctx.fillStyle = '#0d5b2e';
          ctx.beginPath();
          ctx.moveTo(px+TILE*0.5, py+4);
          ctx.lineTo(px+4, py+TILE*0.65);
          ctx.lineTo(px+TILE-4, py+TILE*0.65);
          ctx.closePath();
          ctx.fill();
          ctx.fillStyle = '#ecf7ff';
          ctx.fillRect(px+6,py+6,6,2);
          break;
        case 2:
          ctx.fillStyle = '#6f6f6f';
          ctx.fillRect(px+6,py+10,TILE-12,TILE-8);
          break;
        case 3:
          ctx.fillStyle = '#0f5e2a';
          ctx.fillRect(px+4,py+8,TILE-8,TILE-6);
          ctx.fillStyle = '#ff293b';
          ctx.fillRect(px+8,py+12,2,2);
          break;
        case 4:
          ctx.fillStyle = '#dfefff';
          ctx.fillRect(px,py,TILE,TILE);
          break;
        case 5:
          ctx.fillStyle = '#073a6b';
          ctx.fillRect(px,py,TILE,TILE);
          break;
      }
    }
  }

  items.forEach(it=>{
    const px = it.xTile*TILE + TILE/2;
    const py = it.yTile*TILE + TILE/2;
    if(it.found){
      ctx.fillStyle = '#ffd86b';
      ctx.fillRect(px-4,py-4,8,8);
    }
  });

  drawPlayer(ctx, player.x, player.y);
}

function addInventoryItem(type){
  const inv = document.getElementById('inventory');
  const div = document.createElement('div');
  div.className='item';
  div.textContent = type;
  inv.appendChild(div);

  setTimeout(()=>div.style.transform='scale(1.05)',50);
  setTimeout(()=>div.style.transform='',380);
}

function loop(){
  update();
  draw();
  requestAnimationFrame(loop);
}

// Initialize game
startGameTimer();
loop();

// Load initial leaderboard
loadLeaderboard();
</script>
</body>
</html>