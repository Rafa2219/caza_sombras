<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"/>
<title>La B√∫squeda Navide√±a ‚Äî Pixel Adventure</title>
<style>
/* [MANTENER TODOS TUS ESTILOS CSS EXISTENTES] */
:root{
  --bg: #0a1e23;
  --panel: #0f2b35;
  --accent: #ffb347;
  --text: #f0f8ff;
  --success: #4CAF50;
  --warning: #FF9800;
  --error: #f44336;
}

html,body { 
  height:100%; 
  margin:0; 
  background: linear-gradient(180deg, #0a2b3a, #051a25); 
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
  -webkit-font-smoothing:antialiased; 
  -moz-osx-font-smoothing:grayscale; 
  touch-action: none; 
  color: var(--text);
}

#gameWrap { 
  width:100%; 
  height:100vh; 
  display:flex; 
  flex-direction:column; 
  align-items:center; 
  justify-content:center; 
  gap:12px; 
  box-sizing:border-box; 
  padding:16px; 
}

canvas { 
  image-rendering: pixelated; 
  background: linear-gradient(180deg, #0a3a4a, #063240); 
  border-radius:12px; 
  box-shadow: 0 12px 40px rgba(0,0,0,0.7); 
  border: 2px solid rgba(255, 179, 71, 0.3);
}

.hud { 
  width:100%; 
  max-width:900px; 
  display:flex; 
  justify-content:space-between; 
  align-items:center; 
  color:var(--text); 
  gap:12px; 
}

.panel { 
  background: rgba(15, 43, 53, 0.9); 
  padding:12px 16px; 
  border-radius:12px; 
  display:flex; 
  gap:12px; 
  align-items:center; 
  border: 1px solid rgba(255, 179, 71, 0.2);
  backdrop-filter: blur(10px);
}

.button { 
  background: var(--accent); 
  color:#1a1a1a; 
  padding:8px 16px; 
  border-radius:8px; 
  cursor:pointer; 
  font-weight:700; 
  border:none; 
  transition: all 0.2s ease;
  box-shadow: 0 4px 12px rgba(255, 179, 71, 0.3);
}

.button:hover {
  background: #ffa53d;
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(255, 179, 71, 0.4);
}

#inventory { 
  display:flex; 
  gap:10px; 
  align-items:center; 
}

.item { 
  display:flex; 
  gap:8px; 
  align-items:center; 
  padding:8px 12px; 
  background: rgba(255, 255, 255, 0.1); 
  border-radius:8px; 
  border: 1px solid rgba(255, 255, 255, 0.2);
  font-weight: 600;
}

#mobileControls { 
  position: absolute; 
  bottom:24px; 
  left:24px; 
  display:none; 
  gap:10px; 
}

.dpad { 
  width:150px; 
  height:150px; 
  background: rgba(15, 43, 53, 0.9); 
  border-radius:16px; 
  display:grid; 
  grid-template-columns:repeat(3,1fr); 
  grid-template-rows:repeat(3,1fr); 
  border: 2px solid rgba(255, 179, 71, 0.3);
  backdrop-filter: blur(10px);
}

.dpad button { 
  background:transparent; 
  border:0; 
  color:transparent; 
  transition: background 0.2s ease;
}

.dpad button:active {
  background: rgba(255, 179, 71, 0.3);
}

/* Modal styles */
.modal { 
  display: none; 
  position: fixed; 
  top: 0; 
  left: 0; 
  width: 100%; 
  height: 100%; 
  background: rgba(0,0,0,0.85); 
  z-index: 1000; 
  justify-content: center; 
  align-items: center; 
}

.modal-content { 
  background: var(--panel); 
  padding: 24px; 
  border-radius: 16px; 
  max-width: 420px; 
  width: 90%; 
  text-align: center; 
  border: 2px solid var(--accent);
  box-shadow: 0 20px 60px rgba(0,0,0,0.8);
}

.modal input { 
  width: 85%; 
  padding: 12px; 
  margin: 12px 0; 
  border: none; 
  border-radius: 8px; 
  background: rgba(255,255,255,0.15); 
  color: var(--text); 
  font-size: 16px;
  border: 1px solid rgba(255, 179, 71, 0.3);
}

.modal input:focus {
  outline: none;
  border-color: var(--accent);
  background: rgba(255, 255, 255, 0.2);
}

.modal-buttons { 
  display: flex; 
  gap: 12px; 
  justify-content: center; 
  margin-top: 20px; 
}

/* Leaderboard styles */
#leaderboard { 
  margin-top: 20px; 
  max-height: 250px; 
  overflow-y: auto; 
}

.leaderboard-item { 
  display: flex; 
  justify-content: space-between; 
  padding: 8px 0; 
  border-bottom: 1px solid rgba(255,255,255,0.15); 
  font-weight: 500;
}

.leaderboard-item:nth-child(1) { color: gold; font-weight: bold; }
.leaderboard-item:nth-child(2) { color: silver; font-weight: bold; }
.leaderboard-item:nth-child(3) { color: #cd7f32; font-weight: bold; }

/* Collect button for mobile */
#collectBtn { 
  position: absolute; 
  bottom: 24px; 
  right: 24px; 
  display: none; 
  width: 70px; 
  height: 70px; 
  border-radius: 50%; 
  background: var(--accent); 
  color: #1a1a1a; 
  border: none; 
  font-weight: bold; 
  font-size: 14px; 
  box-shadow: 0 6px 20px rgba(255, 179, 71, 0.4);
  transition: all 0.2s ease;
}

#collectBtn:active {
  transform: scale(0.95);
  background: #ffa53d;
}

/* Status message improvements */
#message {
  font-weight: 700;
  font-size: 14px;
  text-shadow: 0 2px 4px rgba(0,0,0,0.5);
}

/* Timer styling */
#timer {
  font-weight: 800;
  color: var(--accent);
  font-size: 18px;
}

/* Inventory item improvements */
#found, #total {
  font-weight: 800;
  color: var(--accent);
  font-size: 18px;
}

/* Start screen styles */
#startScreen {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 24px;
  text-align: center;
  max-width: 600px;
  padding: 40px;
}

#startScreen h1 {
  font-size: 2.5rem;
  margin: 0;
  color: var(--accent);
  text-shadow: 0 0 10px rgba(255, 179, 71, 0.5);
}

#startScreen p {
  font-size: 1.2rem;
  line-height: 1.6;
  opacity: 0.9;
}

#startScreen .instructions {
  background: rgba(255, 255, 255, 0.1);
  padding: 20px;
  border-radius: 12px;
  margin: 20px 0;
  text-align: left;
}

#startScreen .instructions h3 {
  margin-top: 0;
  color: var(--accent);
}

#startScreen .instructions ul {
  padding-left: 20px;
}

#startScreen .instructions li {
  margin-bottom: 8px;
}

@media (max-width:800px){
  #mobileControls { display: block; }
  #collectBtn { display: block; }
  canvas { 
    width:95vw !important; 
    height: calc(95vw * (9/16)) !important; 
  }
  .hud {
    flex-direction: column;
    gap: 8px;
  }
  .panel {
    width: 100%;
    justify-content: center;
  }
}

html, body, canvas { 
  -webkit-touch-callout: none; 
  -webkit-user-select:none; 
  -ms-user-select:none; 
  user-select:none; 
}

/* Scrollbar styling */
#leaderboard::-webkit-scrollbar {
  width: 8px;
}

#leaderboard::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.1);
  border-radius: 4px;
}

#leaderboard::-webkit-scrollbar-thumb {
  background: var(--accent);
  border-radius: 4px;
}

#leaderboard::-webkit-scrollbar-thumb:hover {
  background: #ffa53d;
}

/* User info panel */
.user-info {
  background: rgba(255, 179, 71, 0.1);
  padding: 8px 12px;
  border-radius: 8px;
  border: 1px solid rgba(255, 179, 71, 0.3);
  font-size: 14px;
}
</style>
</head>
<body>
<!-- Start Screen -->
<div id="startScreen" class="modal" style="display: flex;">
  <div class="modal-content">
    <h1>üéÑ La B√∫squeda Navide√±a üéÑ</h1>
    <p>¬°Encuentra todos los regalos navide√±os antes de que nieve demasiado!</p>
    
    <div class="instructions">
      <h3>Instrucciones:</h3>
      <ul>
        <li>Usa las teclas WASD o flechas para moverte</li>
        <li>Presiona E para recoger regalos cuando est√©s cerca</li>
        <li>En m√≥vil, usa los controles t√°ctiles y el bot√≥n RECOGER</li>
        <li>Encuentra todos los regalos lo m√°s r√°pido posible</li>
      </ul>
    </div>
    
    <div class="modal-buttons">
      <button id="startGameBtn" class="button">Comenzar Juego</button>
    </div>
  </div>
</div>

<div id="gameWrap" style="display: none;">
  <div class="hud" style="max-width:900px;">
    <div class="panel">
      <div style="font-weight:800; font-size:1.05rem">La B√∫squeda Navide√±a ‚Äî Pixel Adventure</div>
      <div style="opacity:0.8; margin-left:6px">Encuentra los regalos antes de que nieve demasiado ‚õÑÔ∏è</div>
    </div>

    <div class="panel" style="justify-content:flex-end">
      <div id="userInfo" class="user-info" style="display:none;">
        Jugando como: <span id="currentUser">Usuario</span>
      </div>
      <div id="status">Objetos: <span id="found">0</span>/<span id="total">0</span></div>
      <div id="inventory" style="margin-left:12px"></div>
      <button id="fullscreenBtn" class="button" style="margin-left:12px">Pantalla completa</button>
      <button id="leaderboardBtn" class="button" style="margin-left:12px">Ranking</button>
    </div>
  </div>

  <canvas id="game" width="640" height="360" style="width:960px; height:540px;"></canvas>

  <div style="max-width:900px; width:100%; display:flex; justify-content:space-between; gap:12px;">
    <div class="panel" style="flex:1">
      <div><strong>Controles:</strong> WASD / Flechas para mover. Tecla E para recoger objetos.</div>
    </div>
    <div class="panel" style="width:300px; justify-content:space-between;">
      <div>Tiempo: <span id="timer">0.00</span>s</div>
      <div id="message" style="font-weight:700"></div>
    </div>
  </div>
</div>

<!-- Mobile Controls -->
<div id="mobileControls">
  <div class="dpad" id="dpad">
    <button data-dir="nw"></button><button data-dir="north"></button><button data-dir="ne"></button>
    <button data-dir="west"></button><button data-dir="center"></button><button data-dir="east"></button>
    <button data-dir="sw"></button><button data-dir="south"></button><button data-dir="se"></button>
  </div>
</div>

<!-- Collect Button for Mobile -->
<button id="collectBtn">RECOGER</button>

<!-- Score Submission Modal -->
<div id="scoreModal" class="modal">
  <div class="modal-content">
    <h3>¬°Felicidades! üéâ</h3>
    <p>Has encontrado todos los regalos en <span id="finalTime">0.00</span> segundos</p>
    <div id="userIdSection">
      <input type="text" id="discordId" placeholder="Tu ID de Discord" maxlength="50">
    </div>
    <div id="userBest" style="margin: 10px 0; padding: 8px; background: rgba(255,255,255,0.1); border-radius: 6px; display: none;">
      Tu mejor tiempo: <span id="bestTime">0.00</span>s
    </div>
    <div class="modal-buttons">
      <button class="button" id="submitScore">Guardar Puntaje</button>
      <button class="button" id="playAgainBtn">Jugar de Nuevo</button>
    </div>
  </div>
</div>

<!-- Leaderboard Modal -->
<div id="leaderboardModal" class="modal">
  <div class="modal-content">
    <h3>üèÜ Mejores Puntuaciones</h3>
    <div id="leaderboard">
      <div style="text-align:center; padding:20px;">Cargando...</div>
    </div>
    <div class="modal-buttons">
      <button class="button" id="closeLeaderboard">Cerrar</button>
      <button class="button" id="playAgainFromLeaderboard">Jugar de Nuevo</button>
    </div>
  </div>
</div>
<script>
// ========== CONFIGURACI√ìN ==========
let currentDiscordId = '';
let userBestScore = null;
let gameStarted = false;

// ========== FUNCIONES DE URL ==========
function getUrlParameter(name) {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(name);
}

// Obtener ID de Discord desde la URL
function initializeDiscordId() {
    const urlId = getUrlParameter('id');
    if (urlId) {
        currentDiscordId = decodeURIComponent(urlId);
        document.getElementById('userInfo').style.display = 'flex';
        document.getElementById('currentUser').textContent = currentDiscordId;
        document.getElementById('discordId').value = currentDiscordId;
        
        // Cargar el mejor score del usuario
        loadUserBestScore(currentDiscordId);
    }
}

// ========== FUNCIONES DE API MEJORADAS ==========
async function loadUserBestScore(discordId) {
    try {
        const response = await fetch(`/score/${encodeURIComponent(discordId)}`);
        if (response.ok) {
            const data = await response.json();
            userBestScore = data.score;
            document.getElementById('userBest').style.display = 'block';
            document.getElementById('bestTime').textContent = data.score.toFixed(2);
        }
    } catch (error) {
        console.log('Usuario nuevo o error cargando score anterior');
    }
}

async function submitScore(discordId, score) {
    try {
        const response = await fetch('/score', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                discord_id: discordId,
                score: parseFloat(score)
            })
        });

        const data = await response.json();
        
        if (data.status === 'success') {
            if (data.action === 'updated') {
                showMessage('¬°Nuevo r√©cord personal! üèÜ', 'success');
            } else if (data.action === 'created') {
                showMessage('¬°Primera puntuaci√≥n guardada! ‚úÖ', 'success');
            } else {
                showMessage('Mantienes tu mejor marca üëç', 'info');
            }
            return true;
        } else {
            showMessage(data.message || 'Error al guardar', 'error');
            return false;
        }
    } catch (error) {
        console.error('Error:', error);
        showMessage('Error de conexi√≥n', 'error');
        return false;
    }
}

async function loadLeaderboard() {
    try {
        const response = await fetch('/scores');
        const scores = await response.json();
        const leaderboardElement = document.getElementById('leaderboard');
        
        if (!Array.isArray(scores) || scores.length === 0) {
            leaderboardElement.innerHTML = '<div style="text-align:center; padding:20px;">No hay puntuaciones a√∫n</div>';
            return;
        }
        
        let html = '';
        scores.forEach((score, index) => {
            const isCurrentUser = currentDiscordId && score.discord_id === currentDiscordId;
            const userClass = isCurrentUser ? 'style="background: rgba(255, 179, 71, 0.2); border-radius: 4px; padding: 4px;"' : '';
            html += `
                <div class="leaderboard-item" ${userClass}>
                    <span>${index + 1}. ${score.discord_id}</span>
                    <span>${score.score.toFixed(2)}s</span>
                    <small>${new Date(score.date).toLocaleDateString()}</small>
                </div>
            `;
        });
        
        leaderboardElement.innerHTML = html;
    } catch (error) {
        console.error('Error cargando ranking:', error);
        document.getElementById('leaderboard').innerHTML = 
            `<div style="text-align:center; padding:20px; color:#ff6b6b;">
                Error cargando ranking
            </div>`;
    }
}

// ========== SISTEMA DE TIEMPO CON DECIMALES ==========
let gameTime = 0;
let gameTimer = null;
let startTime = 0;

function startGameTimer() {
    gameTime = 0;
    startTime = performance.now();
    gameTimer = setInterval(updateTimer, 100);
}

function updateTimer() {
    const currentTime = performance.now();
    gameTime = (currentTime - startTime) / 1000;
    document.getElementById('timer').textContent = gameTime.toFixed(2);
}

function stopGameTimer() {
    if (gameTimer) {
        clearInterval(gameTimer);
        gameTimer = null;
    }
}

// ========== FUNCIONES DEL JUEGO ==========
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
const TILE = 32;
const MAP_W = 20, MAP_H = 11;
const PLAYER_SPEED = 2.2;
let foundCount = 0;
let gameCompleted = false;
let nearItem = null;

const player = {
  x: TILE*2 + TILE/2, 
  y: TILE*2 + TILE/2,
  vx: 0, 
  vy: 0,
  dir: 'down',
  animFrame: 0,
  animTick: 0,
  moving: false,
  width: 16,
  height: 20
};

const pressedKeys = new Set();

function showMessage(text, type = 'info') {
    const element = document.getElementById('message');
    element.textContent = text;
    element.style.color = type === 'error' ? '#ff6b6b' : 
                         type === 'success' ? '#51cf66' : '#ffd86b';
    setTimeout(() => element.textContent = '', 3000);
}

function showScoreModal() {
    document.getElementById('finalTime').textContent = gameTime.toFixed(2);
    
    // Si ya hay un ID en la URL, ocultar el campo de entrada
    if (currentDiscordId) {
        document.getElementById('userIdSection').style.display = 'none';
        // Guardar autom√°ticamente y mostrar ranking
        submitScore(currentDiscordId, gameTime).then(success => {
            if (success) {
                document.getElementById('scoreModal').style.display = 'none';
                showLeaderboard();
            }
        });
    } else {
        document.getElementById('userIdSection').style.display = 'block';
        document.getElementById('scoreModal').style.display = 'flex';
        document.getElementById('discordId').focus();
    }
}

function showLeaderboard() {
    loadLeaderboard();
    document.getElementById('leaderboardModal').style.display = 'flex';
}

// ========== SISTEMA DE RECOLECCI√ìN CORREGIDO ==========
function checkNearbyItems() {
    const playerCenterX = player.x;
    const playerCenterY = player.y;
    nearItem = null;
    
    items.forEach(it => {
        if (!it.found) {
            // Calcular la posici√≥n central del item
            const itemCenterX = it.xTile * TILE + TILE/2;
            const itemCenterY = it.yTile * TILE + TILE/2;
            
            // Calcular distancia entre jugador e item
            const distance = Math.sqrt(
                Math.pow(playerCenterX - itemCenterX, 2) + 
                Math.pow(playerCenterY - itemCenterY, 2)
            );
            
            // Si la distancia es menor a 20 p√≠xeles, est√° cerca
            if (distance < 20) {
                nearItem = it;
            }
        }
    });
    
    // Actualizar UI
    if (nearItem) {
        document.getElementById('message').textContent = 'Presiona E para recoger';
        document.getElementById('message').style.color = '#ffd86b';
    } else {
        document.getElementById('message').textContent = '';
    }
}

function collectItem() {
    if (nearItem && !nearItem.found) {
        nearItem.found = true;
        foundCount++;
        document.getElementById('found').textContent = foundCount;
        addInventoryItem(nearItem.type);
        
        // Mostrar efecto visual
        showCollectEffect(nearItem.xTile * TILE + TILE/2, nearItem.yTile * TILE + TILE/2);
        
        nearItem = null;
        document.getElementById('message').textContent = '';
        
        // Verificar si se complet√≥ el juego
        if (foundCount === items.length && !gameCompleted) {
            gameCompleted = true;
            stopGameTimer();
            setTimeout(showScoreModal, 1000);
        }
    }
}

function showCollectEffect(x, y) {
    // Efecto visual simple al recoger
    ctx.fillStyle = '#ffff00';
    ctx.globalAlpha = 0.7;
    ctx.beginPath();
    ctx.arc(x, y, 15, 0, Math.PI * 2);
    ctx.fill();
    ctx.globalAlpha = 1.0;
    
    // Restaurar despu√©s de un frame
    setTimeout(() => {
        draw();
    }, 100);
}

function addInventoryItem(type) {
    const inv = document.getElementById('inventory');
    const div = document.createElement('div');
    div.className = 'item';
    div.textContent = type;
    inv.appendChild(div);
    
    // Animaci√≥n
    div.style.transform = 'scale(0)';
    setTimeout(() => {
        div.style.transition = 'transform 0.3s ease';
        div.style.transform = 'scale(1)';
    }, 10);
    
    showMessage(`¬°${type} encontrado!`, 'success');
}

// ========== FUNCI√ìN PARA REINICIAR EL JUEGO ==========
function resetGame() {
    // Reiniciar variables del juego
    foundCount = 0;
    gameCompleted = false;
    nearItem = null;
    
    // Reiniciar jugador
    player.x = TILE*2 + TILE/2;
    player.y = TILE*2 + TILE/2;
    player.vx = 0;
    player.vy = 0;
    player.dir = 'down';
    player.animFrame = 0;
    player.animTick = 0;
    player.moving = false;
    
    // Reiniciar items
    items.forEach(item => {
        item.found = false;
    });
    
    // Reiniciar inventario
    document.getElementById('inventory').innerHTML = '';
    document.getElementById('found').textContent = '0';
    
    // Reiniciar temporizador
    stopGameTimer();
    startGameTimer();
    
    // Ocultar modales
    document.getElementById('scoreModal').style.display = 'none';
    document.getElementById('leaderboardModal').style.display = 'none';
    
    // Limpiar mensajes
    document.getElementById('message').textContent = '';
    
    // Reiniciar controles
    pressedKeys.clear();
}

// ========== EVENT LISTENERS ==========
document.getElementById('submitScore').addEventListener('click', async () => {
    const discordId = document.getElementById('discordId').value.trim();
    if (!discordId) {
        showMessage('Ingresa tu ID de Discord', 'error');
        return;
    }
    
    const success = await submitScore(discordId, gameTime);
    if (success) {
        document.getElementById('scoreModal').style.display = 'none';
        if (!currentDiscordId) {
            currentDiscordId = discordId;
            document.getElementById('userInfo').style.display = 'flex';
            document.getElementById('currentUser').textContent = currentDiscordId;
        }
        showLeaderboard();
    }
});

document.getElementById('playAgainBtn').addEventListener('click', resetGame);
document.getElementById('playAgainFromLeaderboard').addEventListener('click', resetGame);

document.getElementById('leaderboardBtn').addEventListener('click', showLeaderboard);
document.getElementById('closeLeaderboard').addEventListener('click', () => {
    document.getElementById('leaderboardModal').style.display = 'none';
});

document.getElementById('collectBtn').addEventListener('click', collectItem);

// Prevenir que los modales se cierren al hacer clic fuera
document.querySelectorAll('.modal-content').forEach(content => {
    content.addEventListener('click', (e) => {
        e.stopPropagation();
    });
});

// Permitir cerrar solo los modales espec√≠ficos con clic fuera
document.getElementById('leaderboardModal').addEventListener('click', (e) => {
    if (e.target === document.getElementById('leaderboardModal')) {
        document.getElementById('leaderboardModal').style.display = 'none';
    }
});

// No permitir cerrar el modal de puntuaci√≥n con clic fuera
document.getElementById('scoreModal').addEventListener('click', (e) => {
    // No hacer nada al hacer clic fuera
});

// Iniciar juego desde pantalla de inicio
document.getElementById('startGameBtn').addEventListener('click', () => {
    document.getElementById('startScreen').style.display = 'none';
    document.getElementById('gameWrap').style.display = 'flex';
    gameStarted = true;
    startGameTimer();
});

// ========== DIBUJO Y L√ìGICA DEL JUEGO ==========
function drawPlayer(ctx, px, py) {
    const f = player.animFrame;
    const body = '#ffdf80';
    const hat = '#c62828';
    const muff = '#ffffff';
    
    // Cuerpo
    ctx.fillStyle = body;
    ctx.fillRect(px - 8, py - 12, 16, 20);
    
    // Piernas con animaci√≥n
    ctx.fillStyle = (player.moving && f % 2 === 0) ? '#874b2f' : '#6b3b21';
    ctx.fillRect(px - 6, py + 6, 6, 6);
    ctx.fillRect(px + 0, py + 6, 6, 6);
    
    // Cabeza
    ctx.fillStyle = '#ffd8b6';
    ctx.fillRect(px - 7, py - 20, 14, 12);
    
    // Gorro navide√±o
    ctx.fillStyle = hat;
    ctx.fillRect(px - 10, py - 26, 20, 6);
    
    // Pomp√≥n
    ctx.fillStyle = muff;
    ctx.fillRect(px + 6, py - 28, 4, 4);
}

function drawTile(ctx, tx, ty, tile) {
    const px = tx * TILE, py = ty * TILE;
    switch(tile) {
        case 0: // Hierba
            ctx.fillStyle = '#1e6b3a';
            ctx.fillRect(px, py, TILE, TILE);
            if(Math.random() < 0.03) {
                ctx.fillStyle = '#e6f7ff';
                ctx.fillRect(px + 4, py + 4, 6, 6);
            }
            break;
        case 1: // √Årbol
            ctx.fillStyle = '#4b2c12';
            ctx.fillRect(px + TILE * 0.45, py + TILE * 0.6, TILE * 0.1, TILE * 0.4);
            ctx.fillStyle = '#0d5b2e';
            ctx.beginPath();
            ctx.moveTo(px + TILE * 0.5, py + 4);
            ctx.lineTo(px + 4, py + TILE * 0.65);
            ctx.lineTo(px + TILE - 4, py + TILE * 0.65);
            ctx.closePath();
            ctx.fill();
            ctx.fillStyle = '#ecf7ff';
            ctx.fillRect(px + 6, py + 6, 6, 2);
            break;
        case 2: // Roca
            ctx.fillStyle = '#6f6f6f';
            ctx.fillRect(px + 6, py + 10, TILE - 12, TILE - 8);
            break;
        case 3: // Arbusto
            ctx.fillStyle = '#0f5e2a';
            ctx.fillRect(px + 4, py + 8, TILE - 8, TILE - 6);
            ctx.fillStyle = '#ff293b';
            ctx.fillRect(px + 8, py + 12, 2, 2);
            break;
        case 4: // Camino de nieve
            ctx.fillStyle = '#dfefff';
            ctx.fillRect(px, py, TILE, TILE);
            break;
        case 5: // Agua
            ctx.fillStyle = '#073a6b';
            ctx.fillRect(px, py, TILE, TILE);
            break;
    }
}

function isPassable(tx, ty) {
    if(tx < 0 || ty < 0 || tx >= MAP_W || ty >= MAP_H) return false;
    const t = map[ty][tx];
    return !(t === 1 || t === 2 || t === 5);
}

// ========== INPUT HANDLING ==========
window.addEventListener('keydown', (e) => {
    if (!gameStarted) return;
    
    const k = e.key.toLowerCase();
    pressedKeys.add(k);
    
    if (k === 'e') {
        e.preventDefault();
        collectItem();
    }
    
    if(['arrowup', 'arrowdown', 'arrowleft', 'arrowright', ' '].includes(k)) {
        e.preventDefault();
    }
});

window.addEventListener('keyup', (e) => {
    pressedKeys.delete(e.key.toLowerCase());
});

// Mobile D-Pad
document.getElementById('dpad').addEventListener('touchstart', (ev) => {
    if (!gameStarted) return;
    
    ev.preventDefault();
    const btn = ev.target.closest('button');
    if(!btn) return;
    handleDpad(btn.dataset.dir, true);
});

document.getElementById('dpad').addEventListener('touchend', (ev) => {
    ev.preventDefault();
    handleDpad(null, false);
});

function handleDpad(dir, down) {
    pressedKeys.clear();
    if(down && dir) {
        const mapDir = {
            'north': 'arrowup', 
            'south': 'arrowdown', 
            'west': 'arrowleft',
            'east': 'arrowright',
            'nw': 'q',
            'ne': 'e', 
            'sw': 'z',
            'se': 'c'
        };
        if(mapDir[dir]) pressedKeys.add(mapDir[dir]);
    }
}

// Disable double tap zoom
let lastTouch = 0;
document.addEventListener('touchend', function (e) {
    const now = Date.now();
    if (now - lastTouch <= 300) e.preventDefault();
    lastTouch = now;
}, { passive: false });

// Fullscreen
document.getElementById('fullscreenBtn').addEventListener('click', async () => {
    try {
        if(!document.fullscreenElement) {
            await document.documentElement.requestFullscreen();
        } else {
            await document.exitFullscreen();
        }
    } catch(err) {
        console.log('Error fullscreen:', err);
    }
});

// ========== GAME LOOP ==========
function update() {
    if (!gameStarted || gameCompleted) return;

    let dx = 0, dy = 0;
    if(pressedKeys.has('arrowup') || pressedKeys.has('w')) dy -= 1;
    if(pressedKeys.has('arrowdown') || pressedKeys.has('s')) dy += 1;
    if(pressedKeys.has('arrowleft') || pressedKeys.has('a')) dx -= 1;
    if(pressedKeys.has('arrowright') || pressedKeys.has('d')) dx += 1;
    
    // Normalizar movimiento diagonal
    if(dx !== 0 && dy !== 0) {
        dx *= Math.SQRT1_2;
        dy *= Math.SQRT1_2;
    }
    
    player.vx = dx * PLAYER_SPEED;
    player.vy = dy * PLAYER_SPEED;
    player.moving = (dx !== 0 || dy !== 0);

    // Movimiento con colisi√≥n
    const nextX = player.x + player.vx;
    const nextY = player.y + player.vy;
    
    // Verificar colisi√≥n en X
    if(isPassable(Math.floor((nextX - 8) / TILE), Math.floor(player.y / TILE)) &&
       isPassable(Math.floor((nextX + 8) / TILE), Math.floor(player.y / TILE))) {
        player.x = nextX;
    }
    
    // Verificar colisi√≥n en Y
    if(isPassable(Math.floor(player.x / TILE), Math.floor((nextY - 12) / TILE)) &&
       isPassable(Math.floor(player.x / TILE), Math.floor((nextY + 8) / TILE))) {
        player.y = nextY;
    }

    // Actualizar direcci√≥n
    if(player.vx > 0) player.dir = 'right';
    else if(player.vx < 0) player.dir = 'left';
    else if(player.vy > 0) player.dir = 'down';
    else if(player.vy < 0) player.dir = 'up';

    // Animaci√≥n
    if(player.moving) {
        player.animTick++;
        if(player.animTick > 6) {
            player.animTick = 0;
            player.animFrame = (player.animFrame + 1) % 4;
        }
    } else {
        player.animTick++;
        if(player.animTick > 12) {
            player.animTick = 0;
            player.animFrame = 0;
        }
    }

    // Verificar items cercanos
    checkNearbyItems();
}

function draw() {
    // Limpiar canvas
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // Dibujar mapa
    for(let y = 0; y < MAP_H; y++) {
        for(let x = 0; x < MAP_W; x++) {
            drawTile(ctx, x, y, map[y][x]);
        }
    }

    // Dibujar items
    items.forEach(it => {
        const px = it.xTile * TILE + TILE/2;
        const py = it.yTile * TILE + TILE/2;
        
        if(!it.found) {
            // Dibujar item visible
            ctx.fillStyle = it.color;
            ctx.fillRect(px - 6, py - 6, 12, 12);
            
            // Dibujar s√≠mbolo
            ctx.fillStyle = '#000';
            ctx.font = '10px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(it.symbol, px, py);
            
            // Resaltar si est√° cerca
            if (nearItem === it) {
                ctx.strokeStyle = '#ffff00';
                ctx.lineWidth = 2;
                ctx.strokeRect(px - 8, py - 8, 16, 16);
            }
        } else {
            // Dibujar como recogido (brillo)
            ctx.fillStyle = '#ffd86b';
            ctx.fillRect(px - 4, py - 4, 8, 8);
        }
    });

    // Dibujar jugador
    drawPlayer(ctx, player.x, player.y);
}

function loop() {
    update();
    draw();
    requestAnimationFrame(loop);
}

// ========== INICIALIZACI√ìN DEL JUEGO ==========
// Mapa
const map = [];
for(let y = 0; y < MAP_H; y++) {
    map[y] = [];
    for(let x = 0; x < MAP_W; x++) {
        if(y === 0 || y === MAP_H - 1 || x === 0 || x === MAP_W - 1) {
            map[y][x] = 1; // Bordes son √°rboles
        } else {
            map[y][x] = Math.random() < 0.05 ? 2 : 
                        (Math.random() < 0.12 ? 3 : 
                        (Math.random() < 0.02 ? 5 : 0));
        }
    }
}

// Agregar algunos √°rboles decorativos
for(let i = 0; i < 14; i++) {
    const tx = 2 + Math.floor(Math.random() * (MAP_W - 4));
    const ty = 2 + Math.floor(Math.random() * (MAP_H - 4));
    map[ty][tx] = 1;
}

// Items
const items = [];
const ITEM_TYPES = [
    { name: 'regalo_rojo', color: '#ff4444', symbol: 'üéÅ' },
    { name: 'regalo_verde', color: '#44ff44', symbol: 'üéÅ' },
    { name: 'mu√±eco_nieve', color: '#ffffff', symbol: '‚õÑ' }
];

// Colocar items en posiciones accesibles
for(let i = 0; i < 10; i++) {
    let tries = 0;
    while(tries < 100) {
        const rx = 1 + Math.floor(Math.random() * (MAP_W - 2));
        const ry = 1 + Math.floor(Math.random() * (MAP_H - 2));
        
        // Solo colocar en tiles pasables (hierba o camino)
        if(map[ry][rx] === 0 || map[ry][rx] === 4) {
            const itemType = ITEM_TYPES[Math.floor(Math.random() * ITEM_TYPES.length)];
            items.push({
                xTile: rx,
                yTile: ry,
                type: itemType.name,
                color: itemType.color,
                symbol: itemType.symbol,
                found: false
            });
            break;
        }
        tries++;
    }
}

document.getElementById('total').textContent = items.length;

// Inicializar Discord ID desde URL
initializeDiscordId();

// Iniciar juego
loop();
loadLeaderboard();
</script>
</body>
</html>